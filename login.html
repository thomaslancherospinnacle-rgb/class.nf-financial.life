<!doctype html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/icon/ios/32.png">
  
  <!-- iOS Home Screen Icons -->
  <link rel="apple-touch-icon" href="/icon/ios/180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/ios/152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icon/ios/167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon/ios/180.png">
  
  <!-- Android/Chrome Home Screen -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icon/android/android-launchericon-192-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon/android/android-launchericon-512-512.png">
  <link rel="manifest" href="/manifest.json">
  
  <!-- PWA Settings -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Closing Coalition">
  <meta name="theme-color" content="#1e3a8a">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Non-Forfeiture Financial - Login</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 480px;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header {
      background: #003d82;
      color: white;
      padding: 24px;
      text-align: center;
      border-bottom: 3px solid #002a5c;
    }
    
    .logo {
      width: 90px;
      height: 90px;
      margin: 0 auto 12px;
      display: block;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 4px;
    }
    
    .header p {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 400;
    }
    
    .form-section {
      padding: 32px 24px;
    }
    
    .form-section h2 {
      font-size: 16px;
      font-weight: 600;
      color: #003d82;
      margin: 0 0 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .form-group {
      margin-bottom: 18px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }
    
    input[type="text"],
    input[type="password"],
    input[type="email"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      font-size: 14px;
      font-family: inherit;
      background: white;
      transition: border-color 0.2s;
    }
    
    input:focus {
      outline: none;
      border-color: #003d82;
    }
    
    input:read-only {
      background: #f9f9f9;
      color: #666;
    }
    
    .derived-email {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      font-size: 13px;
      background: #f9f9f9;
      color: #666;
      font-family: 'Courier New', monospace;
    }
    
    .button-group {
      margin-top: 24px;
      display: flex;
      gap: 10px;
    }
    
    button {
      flex: 1;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: background-color 0.2s;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #003d82;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #002a5c;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #555;
      border: 1px solid #ddd;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #e5e5e5;
    }
    
    .message {
      margin-top: 16px;
      padding: 12px;
      font-size: 13px;
      border-left: 3px solid transparent;
      background: #f9f9f9;
      display: none;
    }
    
    .message.show {
      display: block;
    }
    
    .message.success {
      background: #f0f9f4;
      border-color: #10b981;
      color: #065f46;
    }
    
    .message.error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #991b1b;
    }
    
    .message.info {
      background: #eff6ff;
      border-color: #3b82f6;
      color: #1e40af;
    }
    
    .hint {
      margin-top: 12px;
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }
    
    .hint strong {
      color: #003d82;
    }
    
    .form-section.hidden {
      display: none;
    }
    
    .footer {
      padding: 16px 24px;
      background: #f9f9f9;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
    
    @media (max-width: 520px) {
      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="logo.png" alt="Non-Forfeiture Financial" class="logo">
      <h1>Non-Forfeiture Financial</h1>
      <p>Secure Account Access</p>
    </div>

    <!-- LOGIN SECTION -->
    <div id="loginSection" class="form-section">
      <h2>Login</h2>
      
      <div class="form-group">
        <label for="loginName">Full Name</label>
        <input type="text" id="loginName" placeholder="First Last" autocomplete="name">
      </div>

      <div class="form-group">
        <label>Derived Email Address</label>
        <div id="loginDerived" class="derived-email">—</div>
      </div>

      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
      </div>

      <div class="button-group">
        <button type="button" id="btnLogin" class="btn-primary">Login</button>
      </div>

      <div id="loginMsg" class="message"></div>
    </div>

    <!-- FIRST-TIME REGISTRATION SECTION -->
    <div id="firstTimeSection" class="form-section hidden">
      <h2>Create New Account</h2>
      
      <div class="form-group">
        <label for="regName">Full Name</label>
        <input type="text" id="regName" placeholder="First Last" autocomplete="name" readonly>
      </div>

      <div class="form-group">
        <label>Personal Email Address</label>
        <div id="regDerivedEmail" class="derived-email">—</div>
        <div class="hint">This email will be used for verification codes and password resets.</div>
      </div>

      <div class="form-group">
        <label for="regPassword">Create Password</label>
        <input type="password" id="regPassword" placeholder="Minimum 6 characters" autocomplete="new-password">
      </div>

      <div class="form-group">
        <label for="regConfirmPassword">Confirm Password</label>
        <input type="password" id="regConfirmPassword" placeholder="Re-enter password" autocomplete="new-password">
      </div>

      <div class="button-group">
        <button type="button" id="btnCreateAccount" class="btn-primary">Create Account</button>
        <button type="button" id="btnBackToLogin" class="btn-secondary">Back to Login</button>
      </div>

      <div id="regMsg" class="message"></div>
    </div>

    <!-- EMAIL VERIFICATION SECTION -->
    <div id="verifySection" class="form-section hidden">
      <h2>Verify Your Email</h2>
      
      <div class="form-group">
        <label for="verifyName">Full Name</label>
        <input type="text" id="verifyName" readonly>
      </div>

      <div class="form-group">
        <label for="verifyCode">Verification Code</label>
        <input type="text" id="verifyCode" placeholder="Enter 6-digit code" inputmode="numeric" autocomplete="one-time-code" maxlength="6">
      </div>

      <div class="hint">
        A 6-digit verification code has been sent to <strong id="verifyEmailHint" style="font-family: monospace;">—</strong>
        <br><br>
        Please check your inbox (and spam folder) for the verification code.
      </div>

      <div class="button-group">
        <button type="button" id="btnVerify" class="btn-primary">Verify & Login</button>
        <button type="button" id="btnResendCode" class="btn-secondary">Resend Code</button>
      </div>

      <div id="verifyMsg" class="message"></div>
    </div>

    <div class="footer">
      © 2026 Non-Forfeiture Financial. All rights reserved.
    </div>
  </div>

  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    /**********************
     * CONFIG
     **********************/
    const API_URL = typeof CFWORKER !== 'undefined' ? CFWORKER : '';

    /**********************
     * DOM ELEMENTS
     **********************/
    
    // Sections
    const loginSection = document.getElementById('loginSection');
    const firstTimeSection = document.getElementById('firstTimeSection');
    const verifySection = document.getElementById('verifySection');

    // Login elements
    const loginName = document.getElementById('loginName');
    const loginPassword = document.getElementById('loginPassword');
    const loginDerived = document.getElementById('loginDerived');
    const loginMsg = document.getElementById('loginMsg');
    const btnLogin = document.getElementById('btnLogin');

    // Registration elements
    const regName = document.getElementById('regName');
    const regDerivedEmail = document.getElementById('regDerivedEmail');
    const regPassword = document.getElementById('regPassword');
    const regConfirmPassword = document.getElementById('regConfirmPassword');
    const regMsg = document.getElementById('regMsg');
    const btnCreateAccount = document.getElementById('btnCreateAccount');
    const btnBackToLogin = document.getElementById('btnBackToLogin');

    // Verification elements
    const verifyName = document.getElementById('verifyName');
    const verifyCode = document.getElementById('verifyCode');
    const verifyEmailHint = document.getElementById('verifyEmailHint');
    const verifyMsg = document.getElementById('verifyMsg');
    const btnVerify = document.getElementById('btnVerify');
    const btnResendCode = document.getElementById('btnResendCode');

    // Session variables
    let currentUsername = "";
    let currentEmail = "";
    let currentPassword = "";

    /**********************
     * UTILITY FUNCTIONS
     **********************/

    function showMessage(el, type, text) {
      el.className = `message show ${type}`;
      el.textContent = text || "";
    }

    function clearMessage(el) {
      el.className = "message";
      el.textContent = "";
    }

    function setLoading(btn, loading) {
      btn.disabled = !!loading;
      if (!btn.dataset.originalText) {
        btn.dataset.originalText = btn.textContent;
      }
      btn.textContent = loading ? "Please wait..." : btn.dataset.originalText;
    }

    function showSection(section) {
      loginSection.classList.add('hidden');
      firstTimeSection.classList.add('hidden');
      verifySection.classList.add('hidden');
      
      section.classList.remove('hidden');
      
      clearMessage(loginMsg);
      clearMessage(regMsg);
      clearMessage(verifyMsg);
    }

    function doRedirect() {
      console.log('Redirecting to home.html...');
      console.log('Session check:', {
        token: Auth.getToken(),
        valid: Auth.isSessionValid()
      });
      
      // Use replace instead of href to avoid back button issues
      window.location.replace("home.html");
    }

    /**********************
     * EVENT HANDLERS
     **********************/
    
    // Update derived email as user types in login
    loginName.addEventListener('input', () => {
      const email = Auth.derivedEmailFromName(loginName.value);
      loginDerived.textContent = email || "—";
    });

    // LOGIN BUTTON
    btnLogin.addEventListener('click', async () => {
      clearMessage(loginMsg);

      const username = Auth.normalizeName(loginName.value);
      const password = String(loginPassword.value || "");
      const email = Auth.derivedEmailFromName(loginName.value);

      if (!username) {
        showMessage(loginMsg, 'error', 'Please enter your full name.');
        loginName.focus();
        return;
      }
      if (!password) {
        showMessage(loginMsg, 'error', 'Please enter your password.');
        loginPassword.focus();
        return;
      }

      currentUsername = username;
      currentEmail = email;
      currentPassword = password;

      setLoading(btnLogin, true);
      
      try {
        console.log('Attempting login...');
        const result = await Auth.login(username, password);
        
        console.log('Login successful:', result);
        console.log('Token saved:', Auth.getToken());
        
        showMessage(loginMsg, 'success', 'Login successful! Redirecting...');
        
        // Small delay to show success message
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        doRedirect();

      } catch (e) {
        console.error('Login error:', e);
        
        const errorMsg = e.message;
        
        // Handle "user not found" - new user needs to create account
        if (errorMsg === 'USER_NOT_FOUND') {
          console.log('New user detected, showing registration form');
          
          // Pre-fill registration form
          regName.value = username;
          regDerivedEmail.textContent = email;
          regPassword.value = '';
          regConfirmPassword.value = '';
          
          showSection(firstTimeSection);
          showMessage(regMsg, 'info', 'Welcome! Please create a password to set up your account.');
          regPassword.focus();
        }
        // Handle "not verified" - user exists but hasn't verified email
        else if (errorMsg === 'USER_NOT_VERIFIED') {
          console.log('Unverified user detected, showing verification form');
          
          verifyName.value = username;
          verifyEmailHint.textContent = email;
          verifyCode.value = '';
          
          showSection(verifySection);
          showMessage(verifyMsg, 'info', 'Please verify your email address. Check your inbox for the verification code.');
          verifyCode.focus();
        }
        // Handle all other errors (wrong password, etc.)
        else {
          showMessage(loginMsg, 'error', errorMsg || "Login failed. Please check your credentials.");
        }
        
      } finally {
        setLoading(btnLogin, false);
      }
    });

    // BACK TO LOGIN
    btnBackToLogin.addEventListener('click', () => {
      loginPassword.value = '';
      showSection(loginSection);
      loginName.focus();
    });

    // CREATE ACCOUNT BUTTON
    btnCreateAccount.addEventListener('click', async () => {
      clearMessage(regMsg);

      const username = Auth.normalizeName(regName.value);
      const password = String(regPassword.value || "");
      const confirmPassword = String(regConfirmPassword.value || "");
      const email = regDerivedEmail.textContent;

      // Validation
      if (!username) {
        showMessage(regMsg, 'error', 'Please enter your full name.');
        return;
      }
      if (password.length < 6) {
        showMessage(regMsg, 'error', 'Password must be at least 6 characters.');
        regPassword.focus();
        return;
      }
      if (password !== confirmPassword) {
        showMessage(regMsg, 'error', 'Passwords do not match.');
        regConfirmPassword.focus();
        return;
      }

      currentUsername = username;
      currentEmail = email;
      currentPassword = password;

      setLoading(btnCreateAccount, true);
      
      try {
        console.log('Creating account...');
        await Auth.signup(username, password);
        
        console.log('Account created, showing verification form');
        
        // Move to verification
        verifyName.value = username;
        verifyEmailHint.textContent = email;
        verifyCode.value = '';
        
        showSection(verifySection);
        showMessage(verifyMsg, 'success', 'Account created! Please check your email for the verification code.');
        verifyCode.focus();

      } catch (e) {
        console.error('Signup error:', e);
        showMessage(regMsg, 'error', e.message || "Registration failed. Please try again.");
      } finally {
        setLoading(btnCreateAccount, false);
      }
    });

    // RESEND VERIFICATION CODE
    btnResendCode.addEventListener('click', async () => {
      clearMessage(verifyMsg);

      if (!currentUsername || !currentPassword) {
        showMessage(verifyMsg, 'error', 'Session expired. Please start over.');
        setTimeout(() => {
          showSection(loginSection);
        }, 2000);
        return;
      }

      setLoading(btnResendCode, true);
      
      try {
        await Auth.signup(currentUsername, currentPassword);
        showMessage(verifyMsg, 'success', 'Verification code resent! Please check your email.');
      } catch (e) {
        console.error('Resend error:', e);
        showMessage(verifyMsg, 'error', e.message || "Failed to resend code.");
      } finally {
        setLoading(btnResendCode, false);
      }
    });

    // VERIFY CODE & AUTO-LOGIN
    btnVerify.addEventListener('click', async () => {
      clearMessage(verifyMsg);

      const username = currentUsername;
      const code = String(verifyCode.value || "").trim();
      const password = currentPassword;

      if (!username) {
        showMessage(verifyMsg, 'error', 'Session expired. Please start over.');
        setTimeout(() => {
          showSection(loginSection);
        }, 2000);
        return;
      }
      
      if (!/^\d{6}$/.test(code)) {
        showMessage(verifyMsg, 'error', 'Please enter a valid 6-digit code.');
        verifyCode.focus();
        return;
      }

      setLoading(btnVerify, true);
      
      try {
        console.log('Verifying code...');
        
        // Verify the code
        await Auth.verify(username, code);
        console.log('Verification successful!');
        
        showMessage(verifyMsg, 'success', 'Email verified! Logging you in...');
        
        // Wait for backend to process verification
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Auto-login after verification
        if (password) {
          try {
            console.log('Attempting auto-login after verification...');
            const result = await Auth.login(username, password);
            
            console.log('Auto-login successful:', result);
            console.log('Token saved:', Auth.getToken());
            
            showMessage(verifyMsg, 'success', 'Success! Redirecting...');
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            doRedirect();
            return;
            
          } catch (loginError) {
            console.error('Auto-login failed:', loginError);
            // Fall through to manual login prompt
          }
        }
        
        // Fallback: show login screen with success message
        loginName.value = username;
        loginDerived.textContent = currentEmail;
        loginPassword.value = '';
        
        showSection(loginSection);
        showMessage(loginMsg, 'success', 'Email verified! Please login with your password.');
        loginPassword.focus();

      } catch (e) {
        console.error('Verification error:', e);
        showMessage(verifyMsg, 'error', e.message || "Verification failed. Please check your code.");
      } finally {
        setLoading(btnVerify, false);
      }
    });

    // Allow Enter key to submit forms
    loginPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') btnLogin.click();
    });
    
    regConfirmPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') btnCreateAccount.click();
    });
    
    verifyCode.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') btnVerify.click();
    });

    /**********************
     * INITIALIZATION
     **********************/
    
    // Check if already logged in - DISABLED to prevent redirect loop
    // Only redirect if we have a VALID session that can be verified
    (async () => {
      console.log('Page load - checking session...');
      
      if (Auth.isSessionValid()) {
        console.log('Session appears valid, verifying with server...');
        
        try {
          const isValid = await Auth.validateSession();
          
          if (isValid) {
            console.log('Session verified! Redirecting to home...');
            doRedirect();
          } else {
            console.log('Session validation failed, staying on login');
            Auth.clearSession();
          }
        } catch (e) {
          console.log('Session validation error:', e);
          Auth.clearSession();
        }
      } else {
        console.log('No valid session found');
      }
    })();
    
    // Focus on first input
    loginName.focus();
  </script>
</body>
</html>
